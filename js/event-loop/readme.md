事件循环机制--- 面试必考


# JS 单线程
优点：
1. 节省内存
2. 单线程没有锁的概念，节省上下文切换时间


- 进程：CPU运行指令和保存上下文所需要的时间
理解进程：电脑任务管理器中就是进程，手机同样的，上滑。但是进程是一个相对的描述
     手机的进程就是打开的一个又一个软件，手机电脑都是多进程。
     在电脑的角度也是一样的
     在浏览器上：一个tab页就是一个进程。比如游戏中开语音就是多开一个进程，10年前的浏览器，多开了进程会无响应，所有页面都看不了了（以前没有多进程浏览器，硬件跟不上）
     一个进程不影响另一个进程，
    CPU角度来看进程：工作时间片    
    底层来看：就是一个单位，一个指令到完成这个指令的时间片段

- 线程：进程中更小的单位，描述的是一段指令执行所需的时间
    是进程中的一个更小的部分，
理解线程：打开一个tap页面，输入一个url回车到页面展现的过程：面试：这中间发生了什么？
        浏览器页面的加载我们称之为页面的渲染  页面的渲染对于浏览器来说是一个 机制
        浏览器有个东西叫GPU,绘制功能，找到页面物理发光点会发什么色，可以理解成一个画笔。
        GPU渲染页面过程，我们称之为渲染线程。 为何不叫进程：因为这只是进程的一部分，浏览器一个页面还有后端请求数据，也就是http请求线程
        浏览器进程：GPU渲染线程，http请求线程，js引擎线程……。所以一个进程由多个线程配合工作，这时候会创建一个执行上下文，也就是这个执行的内存空间
        
经典问题：js和css加载是否冲突，不冲突，但是js执行会阻塞html渲染，这两个线程不能同时进行。否则造成不安全的渲染 理解：js能操作dom结构，也就是说js能操作html，以防冲突
    所以js代码放在最后，否则，js里面写个window.onload

## 浏览器新开一个tab页面，就是新开一个进程
需要多个线程配合才能完成页面的展示
1. 渲染线程（GPU）
2. http请求线程
3. js引擎线程

渲染线程（GPU）和js引擎线程 是互斥的
理解：v8执行js就相当于一个进程，进程里面，V8预编译，执行代码就相当于一个线程。v8就是单线程的，从上往下执行，发现异步代码块，会不予理睬往下执行，如果是多线程，异步代码一个线程，同步代码一个线程，

面试官：进程和线程有什么区别？线程是进程的一个小单位。js是单线程，为何不设计成多线程：这门语言设计是为了浏览器脚本语言，多线程就意味着多条腿，高并发，同时间占据的内存会多，设计之初仅仅是个脚本语言，不回去占用很多内存。目的就是降低这门语言对设备性能的开销，这是其一：为了节省内存。另一个点是节约上下文切换的时间：
这样就意味着很慢。
多线程带来的问题就是会导致，假设a同时执行，一个执行+1,一个执行-1，所以有锁的概念



异步分为两部分：js设计之初，发现同步异步两个概念不够，异步还得分，分为宏任务（异步很猛），微任务（异步很少）
# 异步
- 宏任务(macrotask)：script标签、setTimeout、setInterval、setImmediate(指定的dom结构加载完毕再执行，框架的代码用的多)、I/O（输入输出事件，eg.用户点击按钮执行，就是输入）、UI-rendering(页面渲染，与V8引擎关系不大，这个还挺重要，先记着)。这些代码一定是异步，都归红任务管
    同步执行完毕，事件循环机制让任务队列执行异步代码，先执行

- 微任务(microtask):promise.then(promise不是异步，then才是)、MutationObserver(dom发生变化，做出反应，这是个高级方法，设计模式用到的东西)、Process.nextTick(.argv拿到指令,是node中)
这里其实就是promise.then，其余先不管

这两个任务都是个队列

浏览器执行规则：循环执行，同步执行完了，再去循环执行异步
# event-loop----------------------------------------------非常重要
1. 执行同步代码（这属于宏任务）
2. 当执行栈（调用栈）为空，查询是否有异步代码需要执行（理解：同步执行完，调用栈就没了），有就执行微任务
3. 执行完微任务
4. 如果有需要，会渲染页面（js和html才要用这个）
5. 执行宏任务（这也叫下一轮的event-loop的开启）

// js设计多线程，可以但没必要，本身就是脚本语言，不分配内存，多线程就没有同步异步了，异步分为宏，微，两个队列，先执行同步，再微，再宏（第二次event-loop）
// 面试官：微任务一定比宏任务先执行：错！！第一轮就是宏任务，读到script标签就是开启一个宏任务。